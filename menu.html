<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartCafe Premium Menu</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#ff4757;
  --primary-dark:#e63946;
  --bg:#0a0e1a;
  --card:#1a1f35;
  --card-hover:#252b45;
  --text:#f1f5f9;
  --muted:#94a3b8;
  --accent:#06b6d4;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'Outfit',sans-serif;
  background:linear-gradient(135deg,#0a0e1a 0%,#1a1f35 100%);
  color:var(--text);
  min-height:100vh;
  position:relative;
  overflow-x:hidden;
}

body::before{
  content:'';
  position:fixed;
  width:400px;
  height:400px;
  background:radial-gradient(circle,rgba(255,71,87,0.15),transparent);
  top:-200px;
  right:-200px;
  pointer-events:none;
  animation:float 8s ease-in-out infinite;
}

body::after{
  content:'';
  position:fixed;
  width:300px;
  height:300px;
  background:radial-gradient(circle,rgba(6,182,212,0.12),transparent);
  bottom:-150px;
  left:-150px;
  pointer-events:none;
  animation:float 10s ease-in-out infinite reverse;
}

@keyframes float{
  0%,100%{transform:translate(0,0) rotate(0deg)}
  33%{transform:translate(30px,-30px) rotate(5deg)}
  66%{transform:translate(-20px,20px) rotate(-5deg)}
}

/* HEADER */
header{
  background:rgba(26,31,53,0.85);
  backdrop-filter:blur(20px);
  padding:16px 5%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:100;
  border-bottom:1px solid rgba(255,255,255,0.1);
  box-shadow:0 4px 30px rgba(0,0,0,0.3);
}

.logo{
  font-size:1.8rem;
  font-weight:700;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:-1px;
}

.header-actions{
  display:flex;
  gap:12px;
  align-items:center;
}

.admin-btn,.add-btn{
  border-radius:25px;
  padding:10px 20px;
  cursor:pointer;
  font-weight:600;
  font-size:0.9rem;
  transition:all 0.3s ease;
  border:none;
}

.admin-btn{
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.2);
  color:white;
}

.admin-btn:hover{
  background:rgba(255,255,255,0.1);
  transform:translateY(-2px);
}

.add-btn{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:white;
  display:none;
  box-shadow:0 4px 15px rgba(255,71,87,0.3);
}

.add-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(255,71,87,0.4);
}

/* CONTAINER */
.container{
  max-width:1400px;
  margin:0 auto;
  padding:40px 20px 80px;
  position:relative;
  z-index:1;
}

.hero-section{
  text-align:center;
  margin-bottom:50px;
  padding:30px 20px;
}

.hero-section h1{
  font-size:3rem;
  font-weight:700;
  margin-bottom:15px;
  background:linear-gradient(135deg,var(--text),var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

.hero-section p{
  color:var(--muted);
  font-size:1.1rem;
  max-width:600px;
  margin:0 auto;
}

.cat-title{
  font-size:1.8rem;
  font-weight:700;
  margin:50px 0 25px;
  color:var(--text);
  display:flex;
  align-items:center;
  gap:15px;
}

.cat-title::before{
  content:'';
  width:4px;
  height:35px;
  background:linear-gradient(180deg,var(--primary),var(--accent));
  border-radius:10px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:25px;
}

.card{
  background:var(--card);
  border-radius:24px;
  overflow:hidden;
  position:relative;
  transition:all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  border:1px solid rgba(255,255,255,0.05);
  cursor:pointer;
}

.card:hover{
  transform:translateY(-8px);
  background:var(--card-hover);
  box-shadow:0 20px 40px rgba(0,0,0,0.4);
  border-color:rgba(255,71,87,0.3);
}

.img-box{
  height:200px;
  position:relative;
  overflow:hidden;
}

.img-box::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(180deg,transparent 0%,rgba(0,0,0,0.7) 100%);
  opacity:0;
  transition:opacity 0.3s;
}

.card:hover .img-box::after{
  opacity:1;
}

.img-box img{
  width:100%;
  height:100%;
  object-fit:cover;
  transition:transform 0.5s ease;
}

.card:hover .img-box img{
  transform:scale(1.1);
}

.price{
  position:absolute;
  top:15px;
  right:15px;
  background:rgba(0,0,0,0.85);
  backdrop-filter:blur(10px);
  padding:8px 16px;
  border-radius:20px;
  font-size:1rem;
  font-weight:700;
  color:var(--primary);
  z-index:2;
  border:1px solid rgba(255,71,87,0.3);
}

.status-badge{
  position:absolute;
  top:15px;
  left:15px;
  padding:6px 14px;
  border-radius:20px;
  font-size:0.75rem;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.5px;
  z-index:2;
  backdrop-filter:blur(10px);
}

.st-available{background:rgba(34,197,94,0.9);color:#000}
.st-few{background:rgba(251,191,36,0.9);color:#000}
.st-sold{background:rgba(239,68,68,0.9);color:#fff}

.details{
  padding:20px;
}

.details h3{
  font-size:1.2rem;
  margin-bottom:8px;
  color:var(--text);
  font-weight:600;
}

.details p{
  color:var(--muted);
  font-size:0.9rem;
  line-height:1.5;
}

/* ADMIN OVERLAY */
.admin-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.85);
  backdrop-filter:blur(5px);
  display:flex;
  justify-content:center;
  align-items:center;
  gap:12px;
  opacity:0;
  transition:opacity 0.3s ease;
  z-index:10;
}

.card:hover .admin-overlay{
  opacity:1;
}

.btn-edit,.btn-del{
  padding:10px 20px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  font-weight:600;
  transition:all 0.3s ease;
  font-size:0.9rem;
}

.btn-edit{
  background:var(--accent);
  color:#000;
}

.btn-edit:hover{
  transform:scale(1.05);
  box-shadow:0 5px 15px rgba(6,182,212,0.4);
}

.btn-del{
  background:var(--primary);
  color:white;
}

.btn-del:hover{
  transform:scale(1.05);
  box-shadow:0 5px 15px rgba(255,71,87,0.4);
}

/* CHATBOT STYLES */
.chatbot-button{
  position:fixed;
  bottom:30px;
  right:30px;
  width:60px;
  height:60px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  border:none;
  cursor:pointer;
  box-shadow:0 8px 25px rgba(255,71,87,0.4);
  z-index:200;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s ease;
}

.chatbot-button:hover{
  transform:scale(1.1);
  box-shadow:0 10px 30px rgba(255,71,87,0.5);
}

.chatbot-button svg{
  width:30px;
  height:30px;
  fill:white;
}

.chatbot-container{
  position:fixed;
  bottom:100px;
  right:30px;
  width:450px;
  height:600px;
  background:var(--card);
  border-radius:24px;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  display:none;
  flex-direction:column;
  z-index:200;
  border:1px solid rgba(255,255,255,0.1);
  overflow:hidden;
}

.chatbot-container.active{
  display:flex;
}

.chatbot-header{
  background:linear-gradient(135deg,var(--primary),var(--accent));
  padding:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.chatbot-header h3{
  font-size:1.2rem;
  color:white;
  margin:0;
}

.chatbot-close{
  background:rgba(255,255,255,0.2);
  border:none;
  color:white;
  width:30px;
  height:30px;
  border-radius:50%;
  cursor:pointer;
  font-size:1.2rem;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s ease;
}

.chatbot-close:hover{
  background:rgba(255,255,255,0.3);
}

.chatbot-messages{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:15px;
}

.message{
  display:flex;
  gap:10px;
  animation:slideIn 0.3s ease;
}

@keyframes slideIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.message.user{
  flex-direction:row-reverse;
}

.message-avatar{
  width:35px;
  height:35px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  font-size:1.2rem;
}

.message.bot .message-avatar{
  background:linear-gradient(135deg,var(--primary),var(--accent));
}

.message.user .message-avatar{
  background:rgba(255,255,255,0.1);
}

.message-content{
  background:rgba(255,255,255,0.05);
  padding:12px 16px;
  border-radius:16px;
  max-width:80%;
  line-height:1.6;
  font-size:0.95rem;
}

.message.user .message-content{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
}

/* CHAT TABLE STYLES */
.chat-table{
  width:100%;
  border-collapse:collapse;
  margin:10px 0;
  font-size:0.85rem;
  background:rgba(0,0,0,0.2);
  border-radius:8px;
  overflow:hidden;
}

.chat-table thead{
  background:rgba(255,71,87,0.2);
}

.chat-table th{
  padding:8px 10px;
  text-align:left;
  font-weight:600;
  border-bottom:2px solid rgba(255,255,255,0.1);
  color:var(--accent);
}

.chat-table td{
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.05);
}

.chat-table tr:last-child td{
  border-bottom:none;
}

.chat-table tr:hover{
  background:rgba(255,255,255,0.03);
}

.status-available{
  color:#22c55e;
  font-weight:600;
}

.status-few{
  color:#fbbf24;
  font-weight:600;
}

.status-sold{
  color:#ef4444;
  font-weight:600;
}

.chatbot-input-area{
  padding:20px;
  border-top:1px solid rgba(255,255,255,0.1);
  display:flex;
  gap:10px;
}

.chatbot-input{
  flex:1;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;
  padding:12px 16px;
  color:white;
  font-family:'Outfit',sans-serif;
  font-size:0.95rem;
}

.chatbot-input:focus{
  outline:none;
  border-color:var(--primary);
}

.chatbot-send{
  background:linear-gradient(135deg,var(--primary),var(--accent));
  border:none;
  width:45px;
  height:45px;
  border-radius:50%;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s ease;
}

.chatbot-send:hover{
  transform:scale(1.05);
}

.chatbot-send svg{
  width:20px;
  height:20px;
  fill:white;
}

.typing-indicator{
  display:flex;
  gap:5px;
  padding:12px 16px;
}

.typing-indicator span{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--muted);
  animation:typing 1.4s infinite;
}

.typing-indicator span:nth-child(2){
  animation-delay:0.2s;
}

.typing-indicator span:nth-child(3){
  animation-delay:0.4s;
}

@keyframes typing{
  0%,60%,100%{opacity:0.3}
  30%{opacity:1}
}

/* MODALS */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  backdrop-filter:blur(10px);
  z-index:300;
  justify-content:center;
  align-items:center;
  padding:20px;
}

.modal-box{
  background:var(--card);
  padding:35px;
  border-radius:24px;
  width:90%;
  max-width:450px;
  animation:pop 0.3s cubic-bezier(0.175,0.885,0.32,1.275);
  border:1px solid rgba(255,255,255,0.1);
  box-shadow:0 25px 50px rgba(0,0,0,0.5);
}

@keyframes pop{
  from{transform:scale(0.8);opacity:0}
  to{transform:scale(1);opacity:1}
}

.modal-box h2{
  margin:0 0 25px;
  text-align:center;
  font-size:1.8rem;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

input,select,textarea{
  width:100%;
  padding:14px 16px;
  background:rgba(10,14,26,0.8);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:12px;
  color:white;
  margin-bottom:16px;
  font-family:'Outfit',sans-serif;
  font-size:0.95rem;
  transition:all 0.3s ease;
}

input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:var(--primary);
  background:rgba(10,14,26,1);
}

textarea{
  resize:vertical;
  min-height:80px;
}

.save-btn,.cancel-btn{
  width:100%;
  border:none;
  padding:14px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  font-size:1rem;
  transition:all 0.3s ease;
}

.save-btn{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:white;
  margin-bottom:10px;
  box-shadow:0 4px 15px rgba(255,71,87,0.3);
}

.save-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(255,71,87,0.4);
}

.cancel-btn{
  background:transparent;
  color:var(--muted);
  border:1px solid rgba(255,255,255,0.1);
}

.cancel-btn:hover{
  background:rgba(255,255,255,0.05);
  color:var(--text);
}

.error{
  color:var(--primary);
  font-size:0.9rem;
  text-align:center;
  display:none;
  margin-bottom:15px;
  padding:10px;
  background:rgba(255,71,87,0.1);
  border-radius:8px;
}

.loading{
  text-align:center;
  color:var(--muted);
  font-size:1.1rem;
  padding:60px 20px;
}

/* IMAGE PREVIEW */
.image-preview{
  width:100%;
  height:150px;
  border-radius:12px;
  overflow:hidden;
  margin-bottom:16px;
  display:none;
  border:1px solid rgba(255,255,255,0.1);
}

.image-preview img{
  width:100%;
  height:100%;
  object-fit:cover;
}

@media(max-width:768px){
  .hero-section h1{font-size:2rem}
  .grid{
    grid-template-columns:repeat(2,1fr);
    gap:15px;
  }
  .cat-title{font-size:1.5rem}
  .card{border-radius:18px}
  .img-box{height:160px}
  .details{padding:15px}
  .details h3{font-size:1rem}
  .details p{font-size:0.85rem}
  .price{font-size:0.85rem;padding:6px 12px}
  .status-badge{font-size:0.65rem;padding:5px 10px}
  
  .chatbot-container{
    width:calc(100% - 20px);
    right:10px;
    left:10px;
    bottom:90px;
    height:500px;
  }
  
  .chatbot-button{
    right:20px;
    bottom:20px;
  }
}

@media(max-width:480px){
  .logo{font-size:1.4rem}
  .admin-btn,.add-btn{padding:8px 14px;font-size:0.85rem}
  .hero-section h1{font-size:1.6rem}
  .hero-section p{font-size:0.95rem}
  .cat-title{font-size:1.3rem}
  .grid{gap:12px}
  .modal-box{padding:25px}
}

@media(min-width:769px) and (max-width:1024px){
  .grid{grid-template-columns:repeat(3,1fr)}
}

@media(min-width:1025px){
  .grid{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>

<body>

<header>
  <div class="logo">SmartCafe.</div>
  <div class="header-actions">
    <button id="addBtn" class="add-btn" onclick="openAddModal()">+ Add Item</button>
    <button class="admin-btn" id="adminToggle" onclick="handleAdminToggle()">Admin Login</button>
  </div>
</header>

<div class="container">
  <div class="hero-section">
    <h1>SmartCafe Delicious Menu</h1>
    <p>Explore our handcrafted selection of premium dishes made with love</p>
  </div>
  <div id="root">
    <div class="loading">Loading Menu...</div>
  </div>
</div>

<!-- CHATBOT BUTTON -->
<button class="chatbot-button" onclick="toggleChatbot()">
  <svg viewBox="0 0 24 24">
    <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3 .97 4.29L2 22l5.71-.97C9 21.64 10.46 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm0 18c-1.38 0-2.68-.29-3.86-.81l-.28-.13-2.76.47.47-2.76-.13-.28C4.29 14.68 4 13.38 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8-3.59 8-8 8z"/>
  </svg>
</button>

<!-- CHATBOT CONTAINER -->
<div class="chatbot-container" id="chatbotContainer">
  <div class="chatbot-header">
    <h3>SmartCafe Assistant üçΩÔ∏è</h3>
    <button class="chatbot-close" onclick="toggleChatbot()">√ó</button>
  </div>
  <div class="chatbot-messages" id="chatMessages">
    <div class="message bot">
      <div class="message-avatar">ü§ñ</div>
      <div class="message-content">
        Hi! I'm your SmartCafe assistant. Ask me about our menu items, prices, availability, or categories! Try: "Show me all snacks" or "What's available under ‚Çπ100?"
      </div>
    </div>
  </div>
  <div class="chatbot-input-area">
    <input type="text" class="chatbot-input" id="chatInput" placeholder="Ask about our menu..." onkeypress="handleChatKeypress(event)">
    <button class="chatbot-send" onclick="sendMessage()">
      <svg viewBox="0 0 24 24">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="loginModal" class="modal">
  <div class="modal-box">
    <h2>Admin Login</h2>
    <input type="password" id="adminPass" placeholder="Enter Admin Password">
    <div class="error" id="loginError">Wrong password</div>
    <button class="save-btn" onclick="login()">Login</button>
    <button class="cancel-btn" onclick="closeModal('loginModal')">Cancel</button>
  </div>
</div>

<!-- ADD ITEM MODAL -->
<div id="addModal" class="modal">
  <div class="modal-box">
    <h2>Add New Item</h2>
    <input type="text" id="addItemName" placeholder="Item Name">
    <textarea id="addItemDesc" placeholder="Description"></textarea>
    <input type="number" id="addItemPrice" placeholder="Price (‚Çπ)">
    <select id="addItemCategory">
      <option value="">Select Category</option>
      <option value="Snacks">Snacks</option>
      <option value="Breakfast">Breakfast</option>
      <option value="Rice Varieties">Rice Varieties</option>
      <option value="Chinese">Chinese</option>
      <option value="Sides / Gravy">Sides / Gravy</option>
    </select>
    <select id="addItemStatus">
      <option value="available">Available</option>
      <option value="few">Few Left</option>
      <option value="sold">Sold Out</option>
    </select>
    <input type="file" id="addItemImage" accept="image/*" onchange="previewAddImage()">
    <div class="image-preview" id="addImagePreview">
      <img id="addPreviewImg" src="">
    </div>
    <div class="error" id="addFormError">Please fill all required fields</div>
    <button class="save-btn" onclick="addItem()">Add Item</button>
    <button class="cancel-btn" onclick="closeModal('addModal')">Cancel</button>
  </div>
</div>

<!-- EDIT ITEM MODAL -->
<div id="editModal" class="modal">
  <div class="modal-box">
    <h2>Edit Item</h2>
    <div style="margin-bottom:20px;text-align:center;color:var(--muted)">
      <strong id="editItemName" style="color:var(--text);font-size:1.2rem"></strong>
    </div>
    <input type="number" id="editItemPrice" placeholder="Price (‚Çπ)" step="0.01">
    <select id="editItemStatus">
      <option value="available">Available</option>
      <option value="few">Few Left</option>
      <option value="sold">Sold Out</option>
    </select>
    <div class="error" id="editFormError">Please enter a valid price</div>
    <button class="save-btn" onclick="updateItem()">Update Item</button>
    <button class="cancel-btn" onclick="closeModal('editModal')">Cancel</button>
  </div>
</div>

<script>
// CONFIGURATION
const API_URL="https://script.google.com/macros/s/AKfycbzSCTse8s0NoilBdMhwWxN7oTKYVZ87wsnuJ732PGzt3IDeVTg0239UHJMASRlyf9BA/exec";
const CEREBRAS_API_KEY="csk-hf3f2yv2dve2rhn4pm863jfxcf3y3wy2pk3dxfc9c463mkfp";
const CEREBRAS_API_URL="https://api.cerebras.ai/v1/chat/completions";

let menuData=[];
let isAdmin=false;
let editId=null;
let addImageBase64="";

// ADMIN FUNCTIONS
function handleAdminToggle(){
  if(isAdmin){
    isAdmin=false;
    document.getElementById('adminToggle').textContent='Admin Login';
    render();
  }else{
    openLogin();
  }
}

function openLogin(){
  document.getElementById('adminPass').value="";
  document.getElementById('loginError').style.display="none";
  document.getElementById('loginModal').style.display="flex";
}

function login(){
  if(document.getElementById('adminPass').value==="admin123"){
    isAdmin=true;
    document.getElementById('adminToggle').textContent='Logout';
    closeModal('loginModal');
    render();
  }else{
    document.getElementById('loginError').style.display="block";
  }
}

function closeModal(modalId){
  document.getElementById(modalId).style.display="none";
}

// ADD ITEM FUNCTIONS
function openAddModal(){
  addImageBase64="";
  document.getElementById('addFormError').style.display="none";
  document.getElementById('addImagePreview').style.display="none";
  document.getElementById('addItemName').value='';
  document.getElementById('addItemDesc').value='';
  document.getElementById('addItemPrice').value='';
  document.getElementById('addItemCategory').value='';
  document.getElementById('addItemStatus').value='available';
  document.getElementById('addItemImage').value='';
  document.getElementById('addModal').style.display="flex";
}

function previewAddImage(){
  const file=document.getElementById('addItemImage').files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=function(e){
      addImageBase64=e.target.result;
      document.getElementById('addPreviewImg').src=addImageBase64;
      document.getElementById('addImagePreview').style.display="block";
    };
    reader.readAsDataURL(file);
  }
}

async function addItem(){
  const name=document.getElementById('addItemName').value.trim();
  const desc=document.getElementById('addItemDesc').value.trim();
  const price=document.getElementById('addItemPrice').value;
  const category=document.getElementById('addItemCategory').value;
  const status=document.getElementById('addItemStatus').value;
  
  if(!name||!price||!category){
    document.getElementById('addFormError').style.display="block";
    return;
  }
  
  const item={
    id:Date.now().toString(),
    name:name,
    description:desc,
    price:parseFloat(price),
    category:category,
    status:status,
    image:addImageBase64||'https://via.placeholder.com/300'
  };
  
  try{
    const res=await fetch(API_URL,{
      method:'POST',
      body:JSON.stringify({action:'add',item:item})
    });
    
    const result=await res.json();
    console.log('Add result:',result);
    
    if(result.status==='success'){
      closeModal('addModal');
      await fetchMenu();
    }
  }catch(e){
    console.error('Error adding item:',e);
  }
}

// EDIT ITEM FUNCTIONS
function openEditModal(id){
  editId=id;
  const item=menuData.find(i=>String(i.id)===String(id));
  
  if(item){
    document.getElementById('editItemName').textContent=item.name;
    document.getElementById('editItemPrice').value=item.price;
    document.getElementById('editItemStatus').value=item.status;
    document.getElementById('editFormError').style.display="none";
    document.getElementById('editModal').style.display="flex";
  }else{
    console.error('Item not found:',id);
  }
}

async function updateItem(){
  const price=document.getElementById('editItemPrice').value;
  const status=document.getElementById('editItemStatus').value;
  
  if(!price||parseFloat(price)<=0){
    document.getElementById('editFormError').style.display="block";
    return;
  }
  
  const item=menuData.find(i=>String(i.id)===String(editId));
  
  if(item){
    const updatedItem={
      id:item.id,
      name:item.name,
      description:item.description,
      price:parseFloat(price),
      category:item.category,
      status:status.toLowerCase().trim(),
      image:item.image
    };
    
    try{
      const res=await fetch(API_URL,{
        method:'POST',
        body:JSON.stringify({action:'update',item:updatedItem})
      });
      
      const result=await res.json();
      console.log('Update result:',result);
      
      if(result.status==='success'){
        closeModal('editModal');
        await fetchMenu();
      }
    }catch(e){
      console.error('Error updating item:',e);
    }
  }
}

// DELETE ITEM FUNCTION
async function deleteItem(id){
  if(!confirm('Are you sure you want to delete this item?'))return;
  
  try{
    const res=await fetch(API_URL,{
      method:'POST',
      body:JSON.stringify({action:'delete',id:String(id)})
    });
    
    const result=await res.json();
    console.log('Delete result:',result);
    
    if(result.status==='success'){
      await fetchMenu();
    }
  }catch(e){
    console.error('Error deleting item:',e);
  }
}

// FETCH MENU
async function fetchMenu(){
  try{
    const res=await fetch(API_URL+'?action=getMenu&timestamp='+new Date().getTime());
    menuData=await res.json();
    console.log('Menu data loaded:',menuData);
    render();
  }catch(e){
    console.error('Error fetching menu:',e);
    document.getElementById('root').innerHTML='<div class="loading">Error loading menu. Please refresh.</div>';
  }
}

// RENDER MENU
function render(){
  const root=document.getElementById('root');
  root.innerHTML="";
  
  const categories=[...new Set(menuData.map(i=>i.category))];
  
  if(categories.length===0){
    root.innerHTML='<div class="loading">No items in menu yet.</div>';
    document.getElementById('addBtn').style.display=isAdmin?"block":"none";
    return;
  }
  
  categories.forEach(cat=>{
    const items=menuData.filter(i=>i.category===cat);
    let html=`<div class="cat-title">${cat}</div><div class="grid">`;
    
    items.forEach(item=>{
      let badgeClass="st-available",badgeText="Available";
      const itemStatus = String(item.status).toLowerCase().trim();
      
      if(itemStatus==="few"){
        badgeClass="st-few";
        badgeText="Few Left";
      }else if(itemStatus==="sold"){
        badgeClass="st-sold";
        badgeText="Sold Out";
      }
      
      const itemId=String(item.id);
      
      html+=`
      <div class="card" data-id="${itemId}">
        <div class="img-box">
          <span class="price">‚Çπ${item.price}</span>
          <span class="status-badge ${badgeClass}">${badgeText}</span>
          <img src="${item.image||'https://via.placeholder.com/300'}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/300'">
        </div>
        <div class="details">
          <h3>${item.name}</h3>
          <p>${item.description||'Delicious item from our menu'}</p>
        </div>
        ${isAdmin?`
        <div class="admin-overlay">
          <button class="btn-edit" onclick="event.stopPropagation();openEditModal('${itemId}')">Edit</button>
          <button class="btn-del" onclick="event.stopPropagation();deleteItem('${itemId}')">Delete</button>
        </div>`:""}
      </div>`;
    });
    
    root.innerHTML+=html+"</div>";
  });
  
  document.getElementById('addBtn').style.display=isAdmin?"block":"none";
}

// CHATBOT FUNCTIONS
function toggleChatbot(){
  const container=document.getElementById('chatbotContainer');
  container.classList.toggle('active');
}

function handleChatKeypress(event){
  if(event.key==='Enter'){
    sendMessage();
  }
}

async function sendMessage(){
  const input=document.getElementById('chatInput');
  const message=input.value.trim();
  
  if(!message)return;
  
  addMessageToChat('user',message);
  input.value='';
  
  showTypingIndicator();
  
  try{
    const response=await getCerebrasResponse(message);
    removeTypingIndicator();
    addMessageToChat('bot',response,true);
  }catch(e){
    removeTypingIndicator();
    addMessageToChat('bot','Sorry, I encountered an error. Please try again.');
    console.error('Chatbot error:',e);
  }
}

function addMessageToChat(sender,text,isHTML=false){
  const messagesDiv=document.getElementById('chatMessages');
  const messageDiv=document.createElement('div');
  messageDiv.className=`message ${sender}`;
  
  const avatar=document.createElement('div');
  avatar.className='message-avatar';
  avatar.textContent=sender==='bot'?'ü§ñ':'üë§';
  
  const content=document.createElement('div');
  content.className='message-content';
  
  if(isHTML){
    content.innerHTML=text;
  }else{
    content.textContent=text;
  }
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(content);
  messagesDiv.appendChild(messageDiv);
  
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function showTypingIndicator(){
  const messagesDiv=document.getElementById('chatMessages');
  const typingDiv=document.createElement('div');
  typingDiv.className='message bot';
  typingDiv.id='typingIndicator';
  
  const avatar=document.createElement('div');
  avatar.className='message-avatar';
  avatar.textContent='ü§ñ';
  
  const indicator=document.createElement('div');
  indicator.className='typing-indicator';
  indicator.innerHTML='<span></span><span></span><span></span>';
  
  typingDiv.appendChild(avatar);
  typingDiv.appendChild(indicator);
  messagesDiv.appendChild(typingDiv);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function removeTypingIndicator(){
  const indicator=document.getElementById('typingIndicator');
  if(indicator){
    indicator.remove();
  }
}

async function getCerebrasResponse(userMessage){
  const menuContext=createMenuContext();
  
  const systemPrompt=`You are a helpful restaurant menu assistant for SmartCafe. You have access to the current menu data.

IMPORTANT INSTRUCTIONS:
1. When showing multiple menu items, ALWAYS format them as an HTML table.
2. For lists of items with prices and status, use this table format:
   <table class="chat-table">
     <thead><tr><th>Item</th><th>Price</th><th>Status</th></tr></thead>
     <tbody>
       <tr><td>Item Name</td><td>‚ÇπPrice</td><td class="status-available">Available</td></tr>
     </tbody>
   </table>
3. Use these status classes: "status-available", "status-few", "status-sold"
4. For single items or short responses, use regular text.
5. Always use ‚Çπ symbol for prices.

CURRENT MENU DATA:
${menuContext}

Answer questions about menu items, prices, availability, categories, and recommendations. Be friendly and concise.`;

  try{
    const response=await fetch(CEREBRAS_API_URL,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${CEREBRAS_API_KEY}`
      },
      body:JSON.stringify({
        model:'llama-3.3-70b',
        messages:[
          {role:'system',content:systemPrompt},
          {role:'user',content:userMessage}
        ],
        max_tokens:800,
        temperature:0.7
      })
    });
    
    const data=await response.json();
    return data.choices[0].message.content;
  }catch(error){
    console.error('Cerebras API error:',error);
    throw error;
  }
}

function createMenuContext(){
  let context='CATEGORIES AND ITEMS:\n\n';
  
  const categories=[...new Set(menuData.map(i=>i.category))];
  
  categories.forEach(cat=>{
    context+=`${cat}:\n`;
    const items=menuData.filter(i=>i.category===cat);
    items.forEach(item=>{
      const statusText=item.status==='available'?'Available':item.status==='few'?'Few Left':'Sold Out';
      context+=`- ${item.name}: ‚Çπ${item.price} (${statusText})${item.description?' - '+item.description:''}\n`;
    });
    context+='\n';
  });
  
  return context;
}

// INITIALIZE
fetchMenu();
</script>

</body>
</html>
