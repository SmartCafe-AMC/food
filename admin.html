<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - SmartCafe</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #ff4757;
        --primary-dark: #e63946;
        --card: #1a1f35;
        --card-hover: #252b45;
        --text: #f1f5f9;
        --muted: #94a3b8;
        --accent: #06b6d4;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: rgba(255, 71, 87, 0.2);
      }
      html {
        scroll-behavior: smooth;
        -webkit-text-size-adjust: 100%;
      }
      body {
        font-family: "Outfit", sans-serif;
        background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
        background-attachment: fixed;
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
      }
      body::before {
        content: "";
        position: fixed;
        width: 400px;
        height: 400px;
        background: radial-gradient(
          circle,
          rgba(255, 71, 87, 0.15),
          transparent
        );
        top: -200px;
        right: -200px;
        pointer-events: none;
        animation: float 8s ease-in-out infinite;
      }
      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0);
        }
        33% {
          transform: translate(30px, -30px);
        }
        66% {
          transform: translate(-20px, 20px);
        }
      }
      header {
        background: rgba(26, 31, 53, 0.85);
        backdrop-filter: blur(20px);
        padding: 12px 5%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        gap: 10px;
        flex-wrap: wrap;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
      }
      .admin-badge {
        background: var(--primary);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        margin-left: 8px;
      }
      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .add-btn,
      .logout-btn {
        border-radius: 25px;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        border: none;
        min-height: 40px;
        transition: all 0.3s;
        font-family: "Outfit", sans-serif;
      }
      .add-btn {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
      }
      .add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
      }
      .logout-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
      }
      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px 60px;
      }
      .hero-section {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px 10px;
      }
      .hero-section h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--text), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .hero-section p {
        color: var(--muted);
        font-size: 0.95rem;
      }
      .cat-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 30px 0 15px;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .cat-title::before {
        content: "";
        width: 4px;
        height: 26px;
        background: linear-gradient(180deg, var(--primary), var(--accent));
        border-radius: 10px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      .card {
        background: var(--card);
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        transition: all 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
      }
      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        border-color: rgba(255, 71, 87, 0.3);
      }
      .img-box {
        height: 140px;
        position: relative;
        overflow: hidden;
      }
      .img-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .price {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--primary);
        z-index: 2;
        border: 1px solid rgba(255, 71, 87, 0.3);
      }
      .status-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.6rem;
        font-weight: 700;
        text-transform: uppercase;
        z-index: 2;
        backdrop-filter: blur(10px);
      }
      .st-available {
        background: rgba(34, 197, 94, 0.9);
        color: #000;
      }
      .st-few {
        background: rgba(251, 191, 36, 0.9);
        color: #000;
      }
      .st-sold {
        background: rgba(239, 68, 68, 0.9);
        color: #fff;
      }
      .details {
        padding: 12px;
        flex-grow: 1;
      }
      .details h3 {
        font-size: 0.9rem;
        margin-bottom: 5px;
        color: var(--text);
        font-weight: 600;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .details p {
        color: var(--muted);
        font-size: 0.75rem;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .admin-actions {
        display: flex;
        gap: 6px;
        padding: 0 12px 12px;
      }
      .btn-edit,
      .btn-del {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.8rem;
        transition: all 0.3s;
        font-family: "Outfit", sans-serif;
      }
      .btn-edit {
        background: var(--accent);
        color: #000;
      }
      .btn-edit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
      }
      .btn-del {
        background: var(--primary);
        color: white;
      }
      .btn-del:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
      }
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 300;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }
      .modal-box {
        background: var(--card);
        padding: 25px;
        border-radius: 20px;
        width: 95%;
        max-width: 500px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        animation: pop 0.3s;
        max-height: 90vh;
        overflow-y: auto;
      }
      @keyframes pop {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .modal-box h2 {
        margin: 0 0 18px;
        text-align: center;
        font-size: 1.5rem;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      label {
        display: block;
        margin-bottom: 6px;
        color: var(--muted);
        font-size: 0.85rem;
        font-weight: 600;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 11px 13px;
        background: rgba(10, 14, 26, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
        margin-bottom: 14px;
        font-family: "Outfit", sans-serif;
        font-size: 0.9rem;
        transition: all 0.3s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(10, 14, 26, 1);
        box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
      }
      input::placeholder,
      textarea::placeholder {
        color: rgba(148, 163, 184, 0.5);
      }
      textarea {
        resize: vertical;
        min-height: 70px;
      }
      input[type="file"] {
        padding: 8px;
        cursor: pointer;
      }
      .save-btn,
      .cancel-btn {
        width: 100%;
        border: none;
        padding: 12px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.3s;
        font-family: "Outfit", sans-serif;
        min-height: 44px;
      }
      .save-btn {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        margin-bottom: 8px;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
      }
      .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
      }
      .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .cancel-btn {
        background: transparent;
        color: var(--muted);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .cancel-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
      }
      .error {
        color: var(--primary);
        font-size: 0.85rem;
        text-align: center;
        display: none;
        margin-bottom: 12px;
        padding: 10px;
        background: rgba(255, 71, 87, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(255, 71, 87, 0.3);
      }
      .image-preview {
        width: 100%;
        height: 150px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 12px;
        display: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .loading {
        text-align: center;
        color: var(--muted);
        padding: 40px 20px;
        font-size: 0.95rem;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 640px) {
        .hero-section h1 {
          font-size: 1.6rem;
        }
        .add-btn {
          font-size: 0.8rem;
          padding: 8px 12px;
        }
        .logout-btn {
          font-size: 0.8rem;
          padding: 8px 12px;
        }
        .admin-badge {
          font-size: 0.7rem;
          padding: 3px 8px;
        }
        .img-box {
          height: 120px;
        }
        .modal-box {
          padding: 20px;
        }
      }

      @media (min-width: 768px) {
        .grid {
          grid-template-columns: repeat(3, 1fr);
          gap: 18px;
        }
        .img-box {
          height: 160px;
        }
      }

      @media (min-width: 1024px) {
        .grid {
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
        }
        .img-box {
          height: 180px;
        }
        .details {
          padding: 14px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <span class="logo">SmartCafe.</span>
        <span class="admin-badge">ADMIN</span>
      </div>
      <div class="header-actions">
        <button class="add-btn" onclick="openAddModal()">+ Add Item</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="container">
      <div class="hero-section">
        <h1>Admin Panel</h1>
        <p>Manage your menu items</p>
      </div>
      <div id="root">
        <div class="loading">
          <span class="loading-spinner"></span>Loading Menu...
        </div>
      </div>
    </div>

    <!-- ADD MODAL -->
    <div id="addModal" class="modal">
      <div class="modal-box">
        <h2>Add New Item</h2>

        <label>Item Name *</label>
        <input type="text" id="addName" placeholder="e.g. Masala Dosa" required />

        <label>Description</label>
        <textarea id="addDesc" placeholder="Describe the item..."></textarea>

        <label>Price (₹) *</label>
        <input type="number" id="addPrice" placeholder="e.g. 50" step="0.01" required />

        <label>Category *</label>
        <select id="addCategory" required>
          <option value="">Select Category</option>
          <option value="Snacks">Snacks</option>
          <option value="Breakfast">Breakfast</option>
          <option value="Rice Varieties">Rice Varieties</option>
          <option value="Chinese">Chinese</option>
          <option value="Sides / Gravy">Sides / Gravy</option>
        </select>

        <label>Status</label>
        <select id="addStatus">
          <option value="available">Available</option>
          <option value="few">Few Left</option>
          <option value="sold">Sold Out</option>
        </select>

        <label>Upload Image</label>
        <input
          type="file"
          id="addImage"
          accept="image/*"
          onchange="previewAddImage()"
        />
        <div class="image-preview" id="addPreview">
          <img id="addPreviewImg" src="" alt="Preview" />
        </div>

        <div class="error" id="addError">Please fill all required fields</div>
        <button class="save-btn" id="addBtn" onclick="addItem()">Add Item</button>
        <button class="cancel-btn" onclick="closeModal('addModal')">
          Cancel
        </button>
      </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" class="modal">
      <div class="modal-box">
        <h2>Edit Item</h2>

        <label>Item Name *</label>
        <input type="text" id="editName" required />

        <label>Description</label>
        <textarea id="editDesc" placeholder="Describe the item..."></textarea>

        <label>Price (₹) *</label>
        <input type="number" id="editPrice" step="0.01" required />

        <label>Status</label>
        <select id="editStatus">
          <option value="available">Available</option>
          <option value="few">Few Left</option>
          <option value="sold">Sold Out</option>
        </select>

        <label>Replace Image (optional)</label>
        <input
          type="file"
          id="editImage"
          accept="image/*"
          onchange="previewEditImage()"
        />
        <div class="image-preview" id="editPreview">
          <img id="editPreviewImg" src="" alt="Preview" />
        </div>

        <div class="error" id="editError">Please fill all required fields</div>
        <button class="save-btn" id="editBtn" onclick="updateItem()">Update</button>
        <button class="cancel-btn" onclick="closeModal('editModal')">
          Cancel
        </button>
      </div>
    </div>

    <script>
      // REPLACE WITH YOUR MENU APPS SCRIPT URL
      const MENU_API_URL =
        "https://script.google.com/macros/s/AKfycbzJCwL-TlsX70KAnSLvj0q1gasdDYLqXqDY_lQ8Wg7RE3uWFrLq-hRdPfIe5coqKL-b/exec";

      let menuData = [];
      let editId = null;
      let addImageBase64 = "";
      let editImageBase64 = "";

      window.addEventListener("DOMContentLoaded", function () {
        checkAdminAuth();
        fetchMenu();
      });

      function checkAdminAuth() {
        const user = JSON.parse(localStorage.getItem("smartcafe_user") || "{}");
        if (!user.loggedIn || !user.isAdmin) {
          alert("Access Denied: Admin only");
          window.location.href = "login.html";
        }
      }

      function logout() {
        if (confirm("Logout from admin panel?")) {
          localStorage.removeItem("smartcafe_user");
          window.location.href = "login.html";
        }
      }

      async function fetchMenu() {
        try {
          document.getElementById("root").innerHTML =
            '<div class="loading"><span class="loading-spinner"></span>Loading...</div>';
          const response = await fetch(
            MENU_API_URL + "?action=getMenu&t=" + Date.now()
          );
          const data = await response.json();
          menuData = Array.isArray(data) ? data : [];
          renderMenu();
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("root").innerHTML =
            '<div class="loading">Error loading menu. Please refresh.</div>';
        }
      }

      function renderMenu() {
        const root = document.getElementById("root");
        root.innerHTML = "";

        if (menuData.length === 0) {
          root.innerHTML =
            '<div class="loading">No items. Click "+ Add Item" to start.</div>';
          return;
        }

        const categories = [...new Set(menuData.map((i) => i.category))].filter(
          (c) => c
        );

        categories.forEach((cat) => {
          const items = menuData.filter((i) => i.category === cat);
          let html = `<div class="cat-title">${cat}</div><div class="grid">`;

          items.forEach((item) => {
            let badge = "st-available",
              text = "Available";
            const status = String(item.status || "available").toLowerCase();
            if (status === "few") {
              badge = "st-few";
              text = "Few Left";
            } else if (status === "sold") {
              badge = "st-sold";
              text = "Sold Out";
            }

            html += `
        <div class="card">
          <div class="img-box">
            <span class="price">₹${item.price}</span>
            <span class="status-badge ${badge}">${text}</span>
            <img src="${
              item.image || "https://via.placeholder.com/300?text=Food"
            }" alt="${item.name}" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
          </div>
          <div class="details">
            <h3>${item.name}</h3>
            <p>${item.description || "No description"}</p>
          </div>
          <div class="admin-actions">
            <button class="btn-edit" onclick="openEditModal('${
              item.id
            }')">Edit</button>
            <button class="btn-del" onclick="deleteItem('${
              item.id
            }')">Delete</button>
          </div>
        </div>
      `;
          });
          html += "</div>";
          root.innerHTML += html;
        });
      }

      function openAddModal() {
        addImageBase64 = "";
        document.getElementById("addError").style.display = "none";
        document.getElementById("addPreview").style.display = "none";
        document.getElementById("addName").value = "";
        document.getElementById("addDesc").value = "";
        document.getElementById("addPrice").value = "";
        document.getElementById("addCategory").value = "";
        document.getElementById("addStatus").value = "available";
        document.getElementById("addImage").value = "";
        document.getElementById("addModal").style.display = "flex";
      }

      function previewAddImage() {
        const file = document.getElementById("addImage").files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            addImageBase64 = e.target.result;
            document.getElementById("addPreviewImg").src = addImageBase64;
            document.getElementById("addPreview").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      }

      async function addItem() {
        const name = document.getElementById("addName").value.trim();
        const desc = document.getElementById("addDesc").value.trim();
        const price = document.getElementById("addPrice").value;
        const category = document.getElementById("addCategory").value;
        const status = document.getElementById("addStatus").value;

        if (!name || !price || !category) {
          document.getElementById("addError").style.display = "block";
          return;
        }

        const addBtn = document.getElementById("addBtn");
        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="loading-spinner"></span>Adding...';

        const item = {
          id: Date.now().toString(),
          name,
          description: desc,
          price: parseFloat(price),
          category,
          status,
          image: addImageBase64 || "https://via.placeholder.com/300?text=Food",
        };

        try {
          const res = await fetch(MENU_API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "add", item }),
          });
          const result = await res.json();
          if (result.status === "success") {
            closeModal("addModal");
            await fetchMenu();
          } else {
            document.getElementById("addError").textContent =
              result.message || "Failed to add item";
            document.getElementById("addError").style.display = "block";
          }
        } catch (e) {
          console.error(e);
          document.getElementById("addError").textContent =
            "Network error. Please try again.";
          document.getElementById("addError").style.display = "block";
        } finally {
          addBtn.disabled = false;
          addBtn.innerHTML = "Add Item";
        }
      }

      function openEditModal(id) {
        editId = id;
        editImageBase64 = "";
        const item = menuData.find((i) => String(i.id) === String(id));
        if (item) {
          document.getElementById("editName").value = item.name;
          document.getElementById("editDesc").value = item.description || "";
          document.getElementById("editPrice").value = item.price;
          document.getElementById("editStatus").value = item.status;
          document.getElementById("editImage").value = "";
          document.getElementById("editError").style.display = "none";

          // Show current image
          if (item.image) {
            document.getElementById("editPreviewImg").src = item.image;
            document.getElementById("editPreview").style.display = "block";
          } else {
            document.getElementById("editPreview").style.display = "none";
          }

          document.getElementById("editModal").style.display = "flex";
        }
      }

      function previewEditImage() {
        const file = document.getElementById("editImage").files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            editImageBase64 = e.target.result;
            document.getElementById("editPreviewImg").src = editImageBase64;
            document.getElementById("editPreview").style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      }

      async function updateItem() {
        const name = document.getElementById("editName").value.trim();
        const desc = document.getElementById("editDesc").value.trim();
        const price = document.getElementById("editPrice").value;
        const status = document.getElementById("editStatus").value;

        if (!name || !price || parseFloat(price) <= 0) {
          document.getElementById("editError").style.display = "block";
          return;
        }

        const editBtn = document.getElementById("editBtn");
        editBtn.disabled = true;
        editBtn.innerHTML = '<span class="loading-spinner"></span>Updating...';

        const item = menuData.find((i) => String(i.id) === String(editId));
        if (item) {
          const updated = {
            ...item,
            name: name,
            description: desc,
            price: parseFloat(price),
            status: status.toLowerCase(),
          };

          // Update image only if new one is uploaded
          if (editImageBase64) {
            updated.image = editImageBase64;
          }

          try {
            const res = await fetch(MENU_API_URL, {
              method: "POST",
              body: JSON.stringify({ action: "update", item: updated }),
            });
            const result = await res.json();
            if (result.status === "success") {
              closeModal("editModal");
              await fetchMenu();
            } else {
              document.getElementById("editError").textContent =
                result.message || "Failed to update";
              document.getElementById("editError").style.display = "block";
            }
          } catch (e) {
            console.error(e);
            document.getElementById("editError").textContent =
              "Network error. Please try again.";
            document.getElementById("editError").style.display = "block";
          } finally {
            editBtn.disabled = false;
            editBtn.innerHTML = "Update";
          }
        }
      }

      async function deleteItem(id) {
        if (!confirm("Delete this item permanently?")) return;
        try {
          const res = await fetch(MENU_API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "delete", id: String(id) }),
          });
          const result = await res.json();
          if (result.status === "success") await fetchMenu();
        } catch (e) {
          console.error(e);
          alert("Failed to delete item");
        }
      }

      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
    </script>
  </body>
</html>

